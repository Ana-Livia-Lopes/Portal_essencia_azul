<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Catálogo - Portal Essência Azul</title>
    <link rel="stylesheet" href="/css/catalogo.css" />
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&family=Noto+Sans+Arabic:wght@100..900&family=Noto+Serif+Old+Uyghur&display=swap"
        rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="shortcut icon" href="/img/logo.png" type="image/x-icon" />

    <style>
        /* CSS para esconder descrição por padrão */
        .descricao {
            display: none;
            margin-top: 10px;
        }

        .descricao.mostrar {
            display: block;
        }
    </style>
</head>

<body>
    <component-header />
    <component-acessibilidade />
    <component-json-produtos />
    <component-admin-is_logged />
    <section id="quartos" class="seção-plano">
        <h3 class="titulo-w3-agileits titulo conteudo-site">Produtos disponíveis</h3>
        <div class="tabela-preco-principal" id="tabela-preco-principal">

            <article class="coluna card-preco">
                <div class="bloco-preco agile">
                    <div class="topo-preco">
                        <img src="/img/produto2.jpeg" alt="Quarto Amigos" class="img-responsiva" id="imgCamiseta" />
                        <h4 id="infantilAdulto">Camiseta infantil</h4>
                    </div>
                    <div class="fundo-preco">
                        <div class="custom-radios">
                            <div>
                                <input type="radio" id="color-1" name="color" value="color-1" checked />
                                <label for="color-1">
                                    <span onclick="mudar('/img/produto2.jpeg')">
                                        <img id="radio1"
                                            src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/242518/check-icn.svg"
                                            alt="Checked Icon" />
                                    </span>
                                </label>
                            </div>

                            <div>
                                <input type="radio" id="color-2" name="color" value="color-2" />
                                <label for="color-2">
                                    <span onclick="mudar('/img/produto1.png')">
                                        <img src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/242518/check-icn.svg"
                                            alt="Checked Icon" />
                                    </span>
                                </label>
                            </div>

                        </div>
                        <div class="seleção-preco">
                            <h3 id="preco" class="conteudo-site"><span>R$</span>35,00</h3>
                            <button onclick="toggleDescricao(this)" class="conteudo-site">Saiba Mais</button>
                            <button class="btn-editar" onclick="editarProduto(this)">/</button>
                        </div>
                        <div class="descricao">
                            <p>Camiseta ONG Essência Azul cores azul ou branca</p>
                        </div>
                        <div class="descricao">
                            <p>Camiseta ONG Essência Azul cores azul ou branca</p>
                        </div>
                    </div>
                </div>
            </article>

            <article class="coluna card-preco">
                <div class="bloco-preco agile">
                    <div class="topo-preco">
                        <img src="/img/produto3.jpg" alt="Quarto Casal" class="img-responsiva" />
                        <h4 class="conteudo-site">Cordão</h4>
                    </div>
                    <div class="fundo-preco">
                        <div class="custom-radios"></div>
                        <div class="seleção-preco">
                            <h3 class="conteudo-site"><span>R$</span>10,00</h3>
                            <button onclick="toggleDescricao(this)" class="conteudo-site">Saiba Mais</button>
                        <button class="btn-editar" onclick="editarProduto(this)">/</button>  
                        </div>
                        <div class="descricao">
                            <p>Cordão do quebra cabeça de identificação do autismo</p>
                        </div>
                        <div class="descricao">
                            <p>Cordão do quebra cabeça de identificação do autismo</p>
                        </div>
                    </div>
                </div>
            </article>

            <article class="coluna card-preco">
                <div class="bloco-preco agile">
                    <div class="topo-preco">
                        <img src="/img/produto4.jpeg" alt="Quarto Família" class="img-responsiva" />
                        <h4 class="conteudo-site">Cordão</h4>
                    </div>
                    <div class="fundo-preco">
                        <div class="custom-radios"></div>
                        <div class="seleção-preco">
                            <h3 class="conteudo-site"><span>R$</span>10,00</h3>
                            <button onclick="toggleDescricao(this)" class="conteudo-site">Saiba Mais</button>
                            <button class="btn-editar" onclick="editarProduto(this)">/</button>
                        </div>
                        <div class="descricao">
                            <p>Cordão de girassol de identificação do autismo e deficiências ocultas</p>
                        </div>
                        <div class="descricao">
                            <p>Cordão de girassol de identificação do autismo e deficiências ocultas</p>
                        </div>
                    </div>
                </div>
            </article>
        </div>
        <component-admin-catalogo_add_produto />
    </section>

    <section id="secao2">
        <img src="/img/linha.png" id="quebraCabeca" />
    </section>

    <script>
        function createNovaOpcaoForm(nome = "", descricao = "", preco = "", url_imagem) {
            const container = document.getElementById("add-produto-options");
            if (!container) return;
            if (!container.opcoes) container.opcoes = [];

            const optionContainer = document.createElement("div");
            optionContainer.classList.add("optionContainer");

            optionContainer.innerHTML = `
                <hr style="border: 2px solid white; margin: 24px 0;">
                <label class="modal-label">Nome</label>
                <input type="text" name="nome" class="modal-input add-produtos-nome-input" value="${nome}" />

                <label class="modal-label">Descrição</label>
                <textarea name="descricao" class="modal-textarea add-produtos-descricao-input" value="${descricao}"></textarea>

                <label class="modal-label">Preço</label>
                <input type="number" name="preco" class="modal-input add-produtos-preco-input" step="0.1" min="0" value="${preco}" />

                <label class="modal-label">Imagem</label>
                <input type="file" name="imagem" class="modal-input add-produtos-imagem-input" accept="image/*" />
            `;

            optionContainer.fields = {
                url_imagem
            };
            for (const child of optionContainer.children) {
                if (child.tagName === "INPUT" || child.tagName === "TEXTAREA") {
                    const name = child.name;
                    optionContainer.fields[name] = child;
                }
            }

            optionContainer.remove = function () {
                container.removeChild(optionContainer);
                container.opcoes = container.opcoes.filter((opcao) => opcao !== optionContainer);
            };

            const removeButton = document.createElement("i");
            removeButton.classList.add("fa-solid", "fa-trash", "removerOpcaoProduto");
            removeButton.onclick = function () {
                optionContainer.remove();
            };
            optionContainer.appendChild(removeButton);

            container.opcoes.push(optionContainer);
            container.appendChild(optionContainer);
        }

        const radioColors = [""];

        function criarProduto(nome, preco, descricao, imagem, opcoes, id) {
            const mainArticle = document.createElement("article");
            mainArticle.classList.add("coluna", "card-preco");
            const blocoPreco = document.createElement("div");
            blocoPreco.classList.add("bloco-preco", "agile");
            const topoPreco = document.createElement("div");
            topoPreco.classList.add("topo-preco");
            const imgProduto = document.createElement("img");
            imgProduto.src = imagem;
            imgProduto.alt = nome;
            imgProduto.classList.add("img-responsiva");
            const nomeProduto = document.createElement("h4");
            nomeProduto.classList.add("conteudo-site");
            nomeProduto.textContent = nome;
            topoPreco.appendChild(imgProduto);
            topoPreco.appendChild(nomeProduto);
            blocoPreco.appendChild(topoPreco);
            const fundoPreco = document.createElement("div");
            fundoPreco.classList.add("fundo-preco");
            const customRadios = document.createElement("div");
            customRadios.classList.add("custom-radios");
            const selecaoPreco = document.createElement("div");
            selecaoPreco.classList.add("seleção-preco");
            const precoProduto = document.createElement("h3");
            precoProduto.classList.add("conteudo-site");
            precoProduto.innerHTML = `<span>R$</span>${Number.isSafeInteger(preco) ? preco.toFixed(2).replaceAll(".", ",") : preco}`;
            const botaoSaibaMais = document.createElement("button");
            botaoSaibaMais.classList.add("conteudo-site");
            botaoSaibaMais.textContent = "Saiba Mais";
            botaoSaibaMais.onclick = function () {
                toggleDescricao(botaoSaibaMais);
            };
            const descricaoProduto = document.createElement("div");
            descricaoProduto.classList.add("descricao");
            descricaoProduto.innerHTML = `<p>${descricao}</p>`;
            if (window.ISLOGGED) {
                const botoesProduto = document.createElement("div");
                botoesProduto.classList.add("botoes-produto");
                const removerButton = document.createElement("i");
                removerButton.addEventListener("click", () => {
                    Swal.fire({
                        title: "Tem certeza?",
                        text: "Você realmente deseja excluir este produto?",
                        icon: "warning",
                        showCancelButton: true, 
                        confirmButtonColor: "#d33",
                        cancelButtonColor: "#3085d6",
                        confirmButtonText: "Sim, excluir",
                        cancelButtonText: "Cancelar"
                    }).then((result) => {
                        if (result.isConfirmed) {
                            fetch("/api/produtos/" + id, { method: "DELETE" }).then(resp => resp.json()).then(json => {
                                if (json.status === "error") {
                                    Swal.fire({
                                        icon: "error",
                                        title: "Houve um erro...",
                                        text: json.message
                                    });
                                } else {
                                    Swal.fire({
                                        icon: "success",
                                        title: "Sucesso",
                                        text: "Produto excluído com sucesso!"
                                    }).then(() => {
                                        window.location.reload();
                                    });
                                }
                            });
                        }
                    });
                });
                removerButton.classList.add("fa-xmark", "fa-solid", "removerButton");
                const editarButton = document.createElement("i");
                editarButton.addEventListener("click", () => {
                    Swal.fire({
                        title: "Editar produto",
                        html: `
                            <div class="modal-container">
                                <label for="nome-input" class="modal-label">Nome</label>
                                <input type="text" id="nome-input" class="modal-input" value="${nome}" />

                                <label for="descricao-input" class="modal-label">Descrição</label>
                                <textarea id="descricao-input" class="modal-textarea" value=${descricao}></textarea>

                                <label for="preco-input" class="modal-label">Preço</label>
                                <input type="number" id="preco-input" class="modal-input" step="0.01" min="0" value="${preco}" />

                                <label for="imagem-input" class="modal-label">Nova Imagem (opcional)</label>
                                <input type="file" id="imagem-input" class="modal-input" accept="image/*" />

                                <label for="opcoes-input" class="modal-label">Outras opções</label>
                                <div id="add-produto-options">
                                    <i class="fa-solid fa-plus" onclick="createNovaOpcaoForm()"></i>
                                </div>
                            </div>
                        `,
                        confirmButtonText: "Salvar alterações",
                        cancelButtonText: "Cancelar",
                        showCancelButton: true,
                        focusConfirm: false,
                        didOpen: () => {
                            for (const opcao of opcoes) {
                                createNovaOpcaoForm(opcao.nome, opcao.descricao, opcao.preco, opcao.url_imagem);
                            }
                        },
                        preConfirm: () => {
                            const nomeNovo = document.getElementById("nome-input").value;
                            const descricaoNova = document.getElementById("descricao-input").value;
                            const precoNovo = document.getElementById("preco-input").value;
                            const imagemInput = document.getElementById("imagem-input");

                            const formdata = new FormData();

                            if (nomeNovo) formdata.append("nome", nomeNovo);
                            if (descricaoNova) formdata.append("descricao", descricaoNova);
                            if (precoNovo) formdata.append("preco", precoNovo);
                            if (imagemInput.files.length > 0) {
                                formdata.append("blob", imagemInput.files[0]);
                            }
                            const opcoesContainer = document.getElementById("add-produto-options");
                            if (opcoesContainer && opcoesContainer.opcoes) {
                                for (const opcao of opcoesContainer.opcoes) {
                                    const nomeOpcao = opcao.fields.nome.value;
                                    const descricaoOpcao = opcao.fields.descricao.value;
                                    const precoOpcao = opcao.fields.preco.value;
                                    const imagemOpcao = opcao.fields.imagem.files[0];

                                    const opcaoData = {};
                                    if (nomeOpcao) opcaoData.nome = nomeOpcao;
                                    if (descricaoOpcao) opcaoData.descricao = descricaoOpcao;
                                    if (precoOpcao) opcaoData.preco = precoOpcao;
                                    if (opcao.fields.url_imagem) opcaoData.url_imagem = opcao.fields.url_imagem;

                                    console.log(opcaoData)

                                    formdata.append("opcoes[]", JSON.stringify(opcaoData));
                                    if (imagemOpcao) {
                                        formdata.append(`blob_opcao[${Array.from(opcoesContainer.opcoes).indexOf(opcao)}]`, imagemOpcao);
                                    }
                                }
                            }

                            return formdata;
                        }
                    }).then((result) => {
                        if (result.isConfirmed) {
                            const formData = result.value;
                            fetch(`/api/produtos/${id}`, {
                                method: "PATCH",
                                body: formData
                            }).then(resp => resp.json()).then(json => {
                                if (json.status === "error") {
                                    Swal.fire({
                                        icon: "error",
                                        title: "Houve um erro...",
                                        text: json.message
                                    });
                                } else {
                                    Swal.fire({
                                        icon: "success",
                                        title: "Sucesso",
                                        text: "Produto atualizado com sucesso!"
                                    }).then(() => {
                                        window.location.reload();
                                    });
                                }
                            });
                        }
                    });
                });
                editarButton.classList.add("fa-pen-to-square", "fa-solid", "editarButton");
                botoesProduto.appendChild(removerButton);
                botoesProduto.appendChild(editarButton);
                blocoPreco.appendChild(botoesProduto);
            }

            if (opcoes && opcoes.length > 0) {
                const opcoesObjs = [
                    { nome: nomeProduto, preco: precoProduto, descricao: descricaoProduto, imagem: imgProduto }
                ];

                let atual = opcoesObjs[0];
                const opcaoPadrao = opcoesObjs[0];

                function mudarOpcao(opcao = opcaoPadrao) {
                    const nomeAtual = atual.nome ?? opcaoPadrao.nome;
                    const precoAtual = atual.preco ?? opcaoPadrao.preco;
                    const descricaoAtual = atual.descricao ?? opcaoPadrao.descricao;
                    const imagemAtual = atual.imagem ?? opcaoPadrao.imagem;

                    if (opcao.nome) {
                        if (nomeAtual !== opcao.nome) {
                            nomeAtual.insertAdjacentElement("afterend", opcao.nome);
                            nomeAtual.remove();
                        }
                    } else {
                        if (nomeAtual !== opcaoPadrao.nome) {
                            nomeAtual.insertAdjacentElement("afterend", opcaoPadrao.nome);
                            if (atual !== opcaoPadrao) {
                                nomeAtual.remove();
                            }
                        }
                    }
                    if (opcao.preco) {
                        if (precoAtual !== opcao.preco) {
                            precoAtual.insertAdjacentElement("afterend", opcao.preco);
                            precoAtual.remove();
                        }
                    } else {
                        if (precoAtual !== opcaoPadrao.preco) {
                            precoAtual.insertAdjacentElement("afterend", opcaoPadrao.preco);
                            if (atual !== opcaoPadrao) {
                                precoAtual.remove();
                            }
                        }
                    }
                    if (opcao.descricao) {
                        if (descricaoAtual !== opcao.descricao) {
                            descricaoAtual.insertAdjacentElement("afterend", opcao.descricao);
                            descricaoAtual.remove();
                        }
                    } else {
                        if (descricaoAtual !== opcaoPadrao.descricao) {
                            descricaoAtual.insertAdjacentElement("afterend", opcaoPadrao.descricao);
                            if (atual !== opcaoPadrao) {
                                descricaoAtual.remove();
                            }
                        }
                    }
                    if (opcao.imagem) {
                        if (imagemAtual !== opcao.imagem) {
                            imagemAtual.insertAdjacentElement("afterend", opcao.imagem);
                            imagemAtual.remove();
                        }
                    } else {
                        if (imagemAtual !== opcaoPadrao.imagem) {
                            imagemAtual.insertAdjacentElement("afterend", opcaoPadrao.imagem);
                            if (atual !== opcaoPadrao) {
                                imagemAtual.remove();
                            }
                        }
                    }
                    atual = opcao;
                }



                for (const opcao of [{ nome, preco, descricao, imagem }, ...opcoes]) {
                    const opcaoObj = {};
                    if (opcao.nome) {
                        opcaoObj.nome = document.createElement("h4");
                        opcaoObj.nome.classList.add("conteudo-site");
                        opcaoObj.nome.textContent = opcao.nome;
                    }
                    if (opcao.preco) {
                        opcaoObj.preco = document.createElement("h3");
                        opcaoObj.preco.classList.add("conteudo-site");
                        opcaoObj.preco.innerHTML = `<span>R$</span>${Number.isSafeInteger(opcao.preco) ? opcao.preco.toFixed(2).replace(".", ",") : opcao.preco}`;
                    }
                    if (opcao.descricao) {
                        opcaoObj.descricao = document.createElement("div");
                        opcaoObj.descricao.classList.add("descricao");
                        opcaoObj.descricao.innerHTML = `<p>${opcao.descricao}</p>`;
                    }
                    if (opcao.imagem) {
                        opcaoObj.imagem = document.createElement("img");
                        opcaoObj.imagem.src = opcao.imagem;
                        opcaoObj.imagem.alt = opcao.nome || "Produto";
                        opcaoObj.imagem.classList.add("img-responsiva");
                    }

                    const container = document.createElement("div");
                    const input = document.createElement("input");
                    input.type = "radio";
                    input.checked = true;
                    const label = document.createElement("label");
                    const span = document.createElement("span");
                    span.onclick = function () {
                        mudarOpcao(opcaoObj);
                    };
                    const img = document.createElement("img");
                    img.src = "https://s3-us-west-2.amazonaws.com/s.cdpn.io/242518/check-icn.svg";
                    img.alt = "Checked Icon";
                    span.appendChild(img);
                    label.appendChild(span);
                    input.id = `color-${opcao.nome}`;
                    input.name = "color";
                    input.value = `color-${opcao.nome}`;
                    label.htmlFor = input.id;
                    container.appendChild(input);
                    container.appendChild(label);
                    customRadios.appendChild(container);
                }
            }

            fundoPreco.appendChild(customRadios);
            selecaoPreco.appendChild(precoProduto);
            selecaoPreco.appendChild(botaoSaibaMais);
            fundoPreco.appendChild(selecaoPreco);
            fundoPreco.appendChild(descricaoProduto);
            blocoPreco.appendChild(fundoPreco);
            mainArticle.appendChild(blocoPreco);
            return mainArticle;
        }

        function toggleDescricao(botao) {
            const selecaoPreco = botao.parentElement;
            const fundoPreco = selecaoPreco.parentElement;
            const descricao = fundoPreco.querySelector('.descricao');
            descricao.classList.toggle('mostrar');
        }

        function mudar(url) {
            var image = document.getElementById("imgCamiseta");
            image.src = url;
            mudar2(url);
        }

        function mudar2(url) {
            var preco = document.getElementById("preco");

            if (url.includes("produto2.jpeg")) {
                preco.innerHTML = "<span>R$</span>35,00";
            } else if (url.includes("produto1.png")) {
                preco.innerHTML = "<span>R$</span>50,00";
            }
            mudar3(url);
        }

        function mudar3(url) {
            var infantilAdulto = document.getElementById("infantilAdulto");

            if (url.includes("produto2.jpeg")) {
                infantilAdulto.innerHTML = "Camiseta Infantil";
            } else if (url.includes("produto1.png")) {
                infantilAdulto.innerHTML = "Camiseta Adulta";
            }
        }
    </script>

    <script>
        if (window.PRODUTOS) {
            for (const produto of window.PRODUTOS) {
                const { nome, preco, descricao, imagem, opcoes } = produto;
                const produtoElement = criarProduto(nome, preco, descricao, imagem, opcoes, produto.id);
                document.getElementById("tabela-preco-principal").appendChild(produtoElement);
            }
        }

        function editarProduto(botao) {
            const blocoPreco = botao.closest('.bloco-preco');
            if (!blocoPreco) return;

            const nome = blocoPreco.querySelector('h4.conteudo-site')?.textContent || "";
            const precoText = blocoPreco.querySelector('.seleção-preco h3.conteudo-site')?.textContent || "0";
            const preco = precoText.replace('R$', '').replace(',', '.').trim();
            const descricao = blocoPreco.querySelector('.descricao p')?.textContent || "";
            const imagem = blocoPreco.querySelector('img.img-responsiva')?.src || "";

            const produto = {
                nome,
                preco,
                descricao,
                imagem,
                opcoes: []
            };

            Swal.fire({
                title: "Editar produto",
                html: `
                    <div class="modal-container">
                        <label for="nome-input" class="modal-label">Nome</label>
                        <input type="text" id="nome-input" class="modal-input" value="${produto.nome}" />

                        <label for="descricao-input" class="modal-label">Descrição</label>
                        <textarea id="descricao-input" class="modal-textarea">${produto.descricao}</textarea>

                        <label for="preco-input" class="modal-label">Preço</label>
                        <input type="number" id="preco-input" class="modal-input" step="0.01" min="0" value="${produto.preco}" />

                        <label for="imagem-input" class="modal-label">Nova Imagem (opcional)</label>
                        <input type="file" id="imagem-input" class="modal-input" accept="image/*" />
                    </div>
                `,
                confirmButtonText: "Salvar alterações",
                cancelButtonText: "Cancelar",
                showCancelButton: true,
                focusConfirm: false,
                preConfirm: () => {
                    const nomeNovo = document.getElementById("nome-input").value;
                    const descricaoNova = document.getElementById("descricao-input").value;
                    const precoNovo = document.getElementById("preco-input").value;

                    if (!nomeNovo || !descricaoNova || !precoNovo) {
                        Swal.showValidationMessage("Por favor, preencha todos os campos obrigatórios.");
                        return false;
                    }

                    return {
                        nome: nomeNovo,
                        descricao: descricaoNova,
                        preco: precoNovo
                    };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    console.log('Produto editado:', result.value);
                    Swal.fire('Sucesso', 'Produto atualizado com sucesso!', 'success');
                }
            });
        }

    </script>

    <section id="secao3">
        <div class="imagem">
            <img src="/img/bannerCatalogo.png" />
        </div>
        <div class="texto">
            <div class="linha"></div>
            <p id="entendaTitulo" class="conteudo-site">Gostou do catálogo?</p>
            <p id="entenda" class="conteudo-site">Produtos disponíveis em nosso endereço</p>
            <a href="/contato" class="botao conteudo-site">Clique aqui</a>
        </div>
    </section>

    <component-footer />
</body>

</html>