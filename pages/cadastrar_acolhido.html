<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/cad_acolhido.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&family=Noto+Sans+Arabic:wght@100..900&family=Noto+Serif+Old+Uyghur&display=swap"
        rel="stylesheet">
    <title>Cadastrar acolhido</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
    <component-json-cadastrar_acolhido_preload />
    <component-acessibilidade />

    <div class="voltar-div">
        <h3><a class="voltar" href="/gerenciamento"><i class="fa-solid fa-arrow-left" style="color: '#002293;'"></i>
                Voltar</a></h3>
    </div>
    <div class="container">
        <h2 class="conteudo-site">Cadastrar Acolhido</h2>
        <form id="cadastrar-form">
            <div class="form-container">
                <!-- COLUNA RESPONSÁVEL -->
                <div class="coluna">

                    <div class="label-input conteudo-site">
                        <label class="conteudo-site" for="name">Nome:</label>
                        <input class="conteudo-site" type="text" id="name" />
                    </div>

                    <div class="label-input conteudo-site">
                        <label class="conteudo-site" for="data-nascimento">Data de nascimento:</label>
                        <input class="conteudo-site" type="date" id="data-nascimento" />
                    </div>

                    <div class="label-input conteudo-site">
                        <label for="nivel-suporte" class="conteudo-site">Nível de suporte:</label>
                        <select id="nivel-suporte" class="conteudo-site">
                            <option value="" class="conteudo-site">Selecione...</option>
                            <option value="1" class="conteudo-site">Nível 1</option>
                            <option value="2" class="conteudo-site">Nível 2</option>
                            <option value="3" class="conteudo-site">Nível 3</option>
                        </select>
                    </div>

                    <div class="label-input conteudo-site">
                        <label class="conteudo-site">Frequenta escola?</label>
                        <div class="radio">
                            <input class="conteudo-site" type="radio" id="escola-sim" name="escola" value="true" />
                            <label class="conteudo-site" for="escola-sim">Sim</label>

                            <input class="conteudo-site" type="radio" id="escola-nao" name="escola" value="false" />
                            <label class="conteudo-site" for="escola-nao">Não</label>
                        </div>
                    </div>
                    <script>
                        document.addEventListener("DOMContentLoaded", () => {
                            const simRadio = document.getElementById("escola-sim");
                            const naoRadio = document.getElementById("escola-nao");
                            const campoEscola = document.querySelector(".campo-escola");
                            const suporteEscola = document.querySelector(".suporte-escola");

                            campoEscola.style.display = "none";
                            suporteEscola.style.display = "none";

                            simRadio.addEventListener("change", () => {
                                if (simRadio.checked) {
                                    campoEscola.style.display = "block";
                                    suporteEscola.style.display = "block";
                                }
                            });

                            naoRadio.addEventListener("change", () => {
                                if (naoRadio.checked) {
                                    campoEscola.style.display = "none";
                                    suporteEscola.style.display = "none";
                                }
                            });
                        });

                    </script>

                    <div class="campo-escola label-input conteudo-site">
                        <label class="conteudo-site" for="escola">Nome da escola:</label>
                        <input class="conteudo-site" type="text" id="escola" />
                    </div>

                    <div class="suporte-escola label-input conteudo-site">
                        <label class="conteudo-site">Tem suporte na escola?</label>
                        <div class="radio">
                            <input class="conteudo-site" type="radio" id="escola-suporte-sim" name="escola-suporte"
                                value="true" />
                            <label class="conteudo-site" for="escola-suporte-sim">Sim</label>

                            <input class="conteudo-site" type="radio" id="escola-suporte-nao" name="escola-suporte"
                                value="false" />
                            <label class="conteudo-site" for="escola-suporte-nao">Não</label>
                        </div>
                    </div>

                    <div class="label-input conteudo-site">
                        <label class="conteudo-site">CipTEA:</label>
                        <div class="radio">
                            <input class="conteudo-site" type="radio" id="ciptea-sim" name="ciptea" value="true" />
                            <label class="conteudo-site" for="ciptea-sim">Sim</label>

                            <input class="conteudo-site" type="radio" id="ciptea-nao" name="ciptea" value="false" />
                            <label class="conteudo-site" for="ciptea-nao">Não</label>
                        </div>
                    </div>

                    <div class="label-input conteudo-site">
                        <label class="conteudo-site">Cordão de identificação:</label>
                        <div class="radio">
                            <input class="conteudo-site" type="radio" id="cordao-sim" name="cordao" value="true" />
                            <label class="conteudo-site" for="cordao-sim">Sim</label>

                            <input class="conteudo-site" type="radio" id="cordao-nao" name="cordao" value="false" />
                            <label class="conteudo-site" for="cordao-nao">Não</label>
                        </div>
                    </div>
                    <div class="label-input conteudo-site">
                        <label class="conteudo-site">Vaga exclusiva:</label>
                        <div class="radio">
                            <input class="conteudo-site" type="radio" id="vaga-exclusiva-sim" name="vaga-exclusiva"
                                value="true" />
                            <label class="conteudo-site" for="vaga-exclusiva-sim">Sim</label>

                            <input class="conteudo-site" type="radio" id="vaga-exclusiva-nao" name="vaga-exclusiva"
                                value="false" />
                            <label class="conteudo-site" for="vaga-exclusiva-nao">Não</label>
                        </div>
                    </div>

                    <div class="label-input conteudo-site">
                        <label class="conteudo-site" for="interesses">Interesses:</label>
                        <!-- <textarea class="conteudo-site" id="interesses" rows="3"></textarea> -->
                        <div class="list-input" id="interesses"></div>
                    </div>

                    <div class="label-input conteudo-site">
                        <label class="conteudo-site" for="hiperfoco">Hiperfoco:</label>
                        <!-- <textarea class="conteudo-site" id="hiperfoco" rows="3"></textarea> -->
                        <div class="list-input" id="hiperfoco"></div>
                    </div>

                </div>

                <!-- COLUNA ACOLHIDO -->
                <div class="coluna">

                    <div class="label-input conteudo-site">
                        <label class="conteudo-site" for="comoacalma">Como o autista se acalma?</label>
                        <input class="conteudo-site" type="text" id="comoacalma" />
                    </div>


                    <div class="label-input conteudo-site">
                        <label class="conteudo-site" for="naogosta">Atividades que o autista NÃO gosta:</label>
                        <!-- <textarea class="conteudo-site" id="naogosta" rows="3"></textarea> -->
                        <div class="list-input" id="naogosta"></div>
                    </div>

                    <div class="div-alinhamento">
                        <div class="label-input conteudo-site">
                            <label class="conteudo-site" for="restricoes">Restrições Alimentares:</label>
                            <!-- <textarea class="conteudo-site" id="restricoes" rows="3"></textarea> -->
                            <div class="list-input" id="restricoes"></div>
                        </div>

                        <div class="label-input conteudo-site">
                            <label class="conteudo-site" for="comida-fav">Comida favorita:</label>
                            <input class="conteudo-site" type="text" id="comida-fav" />
                        </div>

                        <div class="label-input conteudo-site">
                            <label class="conteudo-site" for="convenio">Convênio ou SUS (qual?):</label>
                            <input class="conteudo-site" type="text" id="convenio" />
                        </div>

                        <div class="label-input conteudo-site">
                            <label class="conteudo-site" for="terapia-faz">Terapias que faz:</label>
                            <!-- <textarea class="conteudo-site" id="terapia-faz" rows="3"></textarea> -->
                            <div class="list-input" id="terapia-faz"></div>
                        </div>

                        <div class="label-input conteudo-site">
                            <label class="conteudo-site" for="terapia-precisa">Terapias que precisa e não faz:</label>
                            <!-- <textarea class="conteudo-site" id="terapia-precisa" rows="3"></textarea> -->
                            <div class="list-input" id="terapia-precisa"></div>
                        </div>


                        <div class="label-input conteudo-site">
                            <label class="conteudo-site" for="url-imagem">Foto:</label>
                            <input class="conteudo-site" type="file" id="foto" />
                        </div>

                        <div class="label-input conteudo-site">
                            <label class="conteudo-site" for="observacoes">Observações:</label>
                            <textarea class="conteudo-site" id="observacoes" rows="4"></textarea>
                        </div>
                    </div>
                </div>

            </div>

            <div class="coluna">
                <h3 class="conteudo-site responsavel"> Responsáveis</h3>

                <!-- responsaveis -->
                <div style="position: relative; margin: 24px 0;">
                    <div id="lista-responsaveis">

                    </div>
                    <div style="display: flex; justify-content: center;">
                        <button onclick="criarResponsavel()" type="button" id="add-responsavel" class="conteudo-site"
                            style="display: flex; align-items: center; gap: 6px;">
                            <i class="fa-solid fa-plus"></i>
                            <p>Adicionar responsável</p>
                        </button>
                    </div>
                    <script>
                        const responsaveisContainer = document.getElementById('lista-responsaveis');
                        responsaveisContainer.responsaveis = [];

                        function criarResponsavel(responsavel) {
                            const mainDiv = document.createElement('div');
                            mainDiv.classList.add('inputs-responsavel');

                            const labelNome = document.createElement('label');
                            labelNome.classList.add('conteudo-site');
                            labelNome.textContent = 'Nome:';
                            mainDiv.appendChild(labelNome);
                            const inputNome = document.createElement('input');
                            inputNome.classList.add('conteudo-site');
                            inputNome.type = 'text';
                            mainDiv.appendChild(inputNome);

                            const subDiv = document.createElement('div');
                            subDiv.classList.add('inputs-responsavel-subfields');

                            const relacaoDiv = document.createElement('div');
                            relacaoDiv.classList.add('inputs-responsavel-relacao');
                            const labelRelacao = document.createElement('label');
                            labelRelacao.classList.add('conteudo-site');
                            labelRelacao.textContent = 'Relação:';
                            relacaoDiv.appendChild(labelRelacao);
                            const inputRelacao = document.createElement('input');
                            inputRelacao.classList.add('conteudo-site');
                            inputRelacao.type = 'text';
                            inputRelacao.placeholder = 'Pai, Mãe, Tio, Avó, ...';
                            relacaoDiv.appendChild(inputRelacao);

                            const contatoDiv = document.createElement('div');
                            contatoDiv.classList.add('inputs-responsavel-contato');
                            const labelContato = document.createElement('label');
                            labelContato.classList.add('conteudo-site');
                            labelContato.textContent = 'Contato:';
                            contatoDiv.appendChild(labelContato);
                            const inputContato = document.createElement('input');
                            inputContato.classList.add('conteudo-site');
                            inputContato.type = 'text';
                            inputContato.placeholder = 'Telefone ou e-mail';
                            contatoDiv.appendChild(inputContato);

                            subDiv.appendChild(relacaoDiv);
                            subDiv.appendChild(contatoDiv);
                            mainDiv.appendChild(subDiv);
                            const hr = document.createElement('hr');
                            mainDiv.appendChild(hr);

                            const i = document.createElement('i');
                            i.classList.add('fa-solid', 'fa-trash');
                            i.style.cursor = 'pointer';
                            i.addEventListener('click', () => {
                                mainDiv.remove();
                                responsaveisContainer.responsaveis = responsaveisContainer.responsaveis.filter(r => r !== mainDiv.responsavel);
                            });
                            mainDiv.appendChild(i);

                            mainDiv.responsavel = {
                                get nome() { return inputNome.value },
                                get relacao() { return inputRelacao.value },
                                get contato() { return inputContato.value }
                            };

                            responsaveisContainer.responsaveis.push(mainDiv.responsavel);
                            responsaveisContainer.appendChild(mainDiv);

                            if (responsavel) {
                                inputNome.value = responsavel.nome || '';
                                inputRelacao.value = responsavel.relacao || '';
                                inputContato.value = responsavel.contato || '';
                            }

                            return mainDiv;
                        }

                        // criarResponsavel();
                    </script>
                </div>
                <!-- outros residentes da casa (responsaveis nao sao incluido automaticamente) -->
                <h3 class="conteudo-site responsavel">Família</h3>
                <!-- opcao de pesquisa de selecionar uma familia ja existente -->

                <div style="display: flex; justify-content: center;">
                    <button type="button" id="buscar-familia" class="conteudo-site"
                        style="display: flex; align-items: center; gap: 6px; margin-bottom: 24px;">
                        <i class="fa-solid fa-search"></i>
                        <p>Buscar família existente</p>
                    </button>
                </div>

                <script>
                    let id_parente;
                    let cachedSearch;
                    let lastSelectedElement;

                    function criarItemAcolhido(acolhido, output) {
                        const div = document.createElement('div');
                        div.classList.add('item');
                        const img = document.createElement('img');
                        img.src = acolhido.fields.url_imagem ? `/api/acolhidos/${acolhido.id}?getImagem=true` : "/img/user-default.png";
                        img.alt = acolhido.fields.nome || "Acolhido";
                        div.appendChild(img);
                        div.appendChild(document.createTextNode(acolhido.fields.nome || "Acolhido"));
                        div.addEventListener("click", () => {
                            if (lastSelectedElement) lastSelectedElement.classList.remove("selected");
                            div.classList.add("selected");
                            lastSelectedElement = div;
                            id_parente = acolhido.id;
                        });
                        output.appendChild(div);
                    }

                    async function pesquisarAcolhidos(input, output) {
                        if (!cachedSearch) cachedSearch = await (await fetch("/api/acolhidos")).json();
                        output.innerHTML = '';
                        for (const acolhido of cachedSearch) {
                            if (acolhido?.fields?.nome?.toLowerCase?.()?.includes(input.toLowerCase()) || !input) {
                                criarItemAcolhido(acolhido, output);
                            }
                        }
                    }

                    document.getElementById("buscar-familia").addEventListener("click", () => {
                        let selected;

                        Swal.fire({
                            showCancelButton: true,
                            title: "Procure um acolhido parente",
                            html: `
                            <div class="search-box">
                                <input type="text" placeholder="Pesquise um acolhido" id="pesquisa-parente" />
                            </div>
                            <div id="pesquisa-output"/>
                                
                            </div>
                            `,
                            didOpen: () => {
                                const input = document.getElementById("pesquisa-parente");
                                input.focus();
                                input.addEventListener("change", async () => {
                                    const output = document.getElementById("pesquisa-output");
                                    const search = await pesquisarAcolhidos(input.value, output);
                                });
                            },
                            preConfirm: () => {
                                return id_parente;
                            }
                        }).then(result => {
                            let id_acolhido = result.isConfirmed ? result.value : null;
                            if (result.isConfirmed && id_acolhido) {
                                document.querySelectorAll(".fa-solid.fa-trash.remover-residente").forEach(i => i.dispatchEvent(new Event("click")));
                                document.getElementById("criar-residente").disabled = true;
                                const enderecoInput = document.getElementById("endereco");
                                enderecoInput.disabled = true;
                                enderecoInput.value = "";
                                
                                id_parente = id_acolhido;
                            } else {
                                id_parente = undefined;
                            }
                        });
                    });
                </script>
                <style>
                    .item {
                        font-size: 18px;
                        /* color: white; */
                        border-bottom: 2px solid #7a9bd5;
                        padding: 8px;
                        cursor: pointer;
                        transition: opacity 0.2s;
                        margin-right: 10px;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                    }

                    .item img {
                        width: 30px;
                    }

                    .item:hover {
                        opacity: 0.8;
                    }

                    .item.selected {
                        background-color: rgb(175, 175, 175);
                    }
                </style>

                <div class="label-input conteudo-site">
                    <label class="conteudo-site" for="endereco">Endereço:</label>
                    <input class="conteudo-site" type="text" id="endereco" placeholder="Rua, número, bairro, cidade"
                        style="width: 100%;" />
                </div>

                <h4>Residentes</h4>
                <div id="lista-residentes">

                </div>

                <div style="display: flex; justify-content: center; margin: 16px 0;">
                    <button onclick="criarResidente()" type="button" id="criar-residente" class="conteudo-site"
                        style="display: flex; align-items: center; gap: 6px;">
                        <i class="fa-solid fa-plus"></i>
                        <p>Criar residente</p>
                    </button>
                </div>

                <script>

                    const residentesContainer = document.getElementById('lista-residentes');
                    residentesContainer.residentes = [];

                    function criarResidente(residente) {
                        const mainDiv = document.createElement('div');
                        mainDiv.classList.add('inputs-residente');
                        const row = document.createElement('div');
                        row.classList.add('row');
                        const nomeDiv = document.createElement('div');
                        nomeDiv.classList.add('inputs-residente-nome');
                        const labelNome = document.createElement('label');
                        labelNome.classList.add('conteudo-site');
                        labelNome.textContent = 'Nome:';
                        nomeDiv.appendChild(labelNome);
                        const inputNome = document.createElement('input');
                        if (residente) inputNome.value = residente.nome;
                        inputNome.classList.add('conteudo-site');
                        inputNome.type = 'text';
                        nomeDiv.appendChild(inputNome);
                        row.appendChild(nomeDiv);
                        const perfilDiv = document.createElement('div');
                        perfilDiv.classList.add('inputs-residente-perfil');
                        const labelPerfil = document.createElement('label');
                        labelPerfil.classList.add('conteudo-site');
                        labelPerfil.textContent = 'Perfil:';
                        perfilDiv.appendChild(labelPerfil);
                        const selectPerfil = document.createElement('select');
                        selectPerfil.classList.add('conteudo-site');
                        const optionDefault = document.createElement('option');
                        optionDefault.value = '';
                        optionDefault.textContent = 'Selecione...';
                        selectPerfil.appendChild(optionDefault);
                        const optionAutista = document.createElement('option');
                        optionAutista.value = 'autista';
                        optionAutista.textContent = 'Autista';
                        selectPerfil.appendChild(optionAutista);
                        const optionNeurotipico = document.createElement('option');
                        optionNeurotipico.value = 'neurotipico';
                        optionNeurotipico.textContent = 'Neurotípico';
                        selectPerfil.appendChild(optionNeurotipico);
                        const optionInvestigacao = document.createElement('option');
                        optionInvestigacao.value = 'em investigacao';
                        optionInvestigacao.textContent = 'Em investigação';
                        selectPerfil.appendChild(optionInvestigacao);
                        if (residente) selectPerfil.value = residente.tipo;
                        perfilDiv.appendChild(selectPerfil);
                        row.appendChild(perfilDiv);
                        mainDiv.appendChild(row);
                        const hr = document.createElement('hr');
                        mainDiv.appendChild(hr);
                        const i = document.createElement('i');
                        i.classList.add('fa-solid', 'fa-trash', 'remover-residente');
                        i.style.cursor = 'pointer';
                        i.addEventListener('click', () => {
                            mainDiv.remove();
                            residentesContainer.residentes = residentesContainer.residentes.filter(r => r !== mainDiv.residente);
                        });
                        mainDiv.appendChild(i);
                        mainDiv.residente = {
                            get nome() { return inputNome.value },
                            get perfil() { return selectPerfil.value }
                        };
                        residentesContainer.residentes.push(mainDiv.residente);
                        residentesContainer.appendChild(mainDiv);
                        return mainDiv;
                    }

                    // criarResidente()
                </script>

                <div class="button-container">
                    <button type="submit" class="conteudo-site">Finalizar cadastro</button>
                </div>
            </div>
        </form>
    </div>
    <script>
        if (window.SOLICITACAO) {
            const fields = window.SOLICITACAO.fields;
            document.getElementById("name").value = fields.nome;
            const data_nascimento = new Date(fields.data_nascimento.seconds * 1000);
            document.getElementById("data-nascimento").value = `${data_nascimento.getFullYear()}-${String(data_nascimento.getMonth() + 1).padStart(2, '0')}-${String(data_nascimento.getDate()).padStart(2, '0')}`;
            document.getElementById("nivel-suporte").value = fields.nivel_suporte;
            document.getElementById("comoacalma").value = fields.como_acalma;
            document.getElementById("comida-fav").value = fields.comida_favorita;
            document.getElementById("convenio").value = fields.convenio;
            document.getElementById("observacoes").value = fields.observacoes;
            document.getElementById("endereco").value = fields.endereco;

            if (fields.identificacoes) {
                if (fields.identificacoes.ciptea !== undefined) {
                    document.getElementById(fields.identificacoes.ciptea ? "ciptea-sim" : "ciptea-nao").checked = true;
                }
                if (fields.identificacoes.cordao !== undefined) {
                    document.getElementById(fields.identificacoes.cordao ? "cordao-sim" : "cordao-nao").checked = true;
                }
                if (fields.identificacoes.vaga_exclusiva !== undefined) {
                    document.getElementById(fields.identificacoes.vaga_exclusiva ? "vaga-exclusiva-sim" : "vaga-exclusiva-nao").checked = true;
                }
            }

            if (fields.escola) {
                document.getElementById(fields.escola.nome ? "escola-sim" : "escola-nao").checked = true;
                if (fields.escola.nome) {
                    document.getElementById("escola").value = fields.escola.nome;
                    if (fields.escola.tem_suporte !== undefined) {
                        document.getElementById(fields.escola.suporte ? "escola-suporte-sim" : "escola-suporte-nao").checked = true;
                    }
                }
                document.querySelector(".campo-escola").style.display = "block";
                document.querySelector(".suporte-escola").style.display = "block";
            }

            if (fields.responsaveis) {
                for (const responsavel of fields.responsaveis) {
                    criarResponsavel(responsavel);
                }
            } else {
                criarResponsavel();
            }

            if (fields.residentes) {
                for (const residente of fields.residentes) {
                    criarResidente(residente);
                }
            } else {
                criarResidente();
            }
        }

        const form = document.getElementById("cadastrar-form");

        form.addEventListener("keydown", function (event) {
            if (event.key === "Enter") {
                event.preventDefault();
            }
        });

        form.addEventListener("submit", event => {
            event.preventDefault();
            const frequentaEscola = document.querySelector('input[name="escola"]:checked')?.value === "true";

            // Validação de campos obrigatórios
            const requiredFields = [
                { id: "name", label: "Nome" },
                { id: "data-nascimento", label: "Data de nascimento" },
                { id: "nivel-suporte", label: "Nível de suporte" },
                { id: "comoacalma", label: "Como o autista se acalma?" },
                { id: "comida-fav", label: "Comida favorita" },
                { id: "convenio", label: "Convênio ou SUS" },
                { id: "endereco", label: "Endereço", fromFamily: true }
            ];

            let missing = [];
            for (const field of requiredFields) {
                const el = document.getElementById(field.id);
                if ((!el.value || (el.type === "select-one" && el.value === "")) && !field.fromFamily) {
                    missing.push(field.label);
                }
            }

            // Validação de escola se frequenta
            if (frequentaEscola) {
                const escolaNome = document.getElementById("escola").value;
                if (!escolaNome) missing.push("Nome da escola");
                const escolaSuporte = document.querySelector('input[name="escola-suporte"]:checked');
                if (!escolaSuporte) missing.push("Tem suporte na escola?");
            }

            // Validação de pelo menos um responsável
            const responsaveisArr = Array.from(document.getElementById("lista-responsaveis").responsaveis);
            if (responsaveisArr.length === 0 || responsaveisArr.some(r => !r.nome || !r.relacao || !r.contato)) {
                missing.push("Responsável (nome, relação e contato)");
            }

            // Validação de pelo menos um residente
            const residentesArr = Array.from(document.getElementById("lista-residentes").residentes);
            if ((residentesArr.length === 0 || residentesArr.some(r => !r.nome || !r.perfil)) && !id_parente) {
                missing.push("Residente (nome e perfil)");
            }

            if (missing.length > 0) {
                Swal.fire({
                    icon: "error",
                    title: "Campos obrigatórios faltando",
                    html: "Por favor, preencha os seguintes campos:<br><ul style='text-align:left'>" + missing.map(m => `<li>${m}</li>`).join("") + "</ul>"
                });
                return;
            }

            const dados = {
                nome: document.getElementById("name").value,
                data_nascimento: new Date(document.getElementById("data-nascimento").value),
                nivel_suporte: parseInt(document.getElementById("nivel-suporte").value),
                identificacoes: {
                    ciptea: Boolean(document.querySelector('input[name="ciptea"]:checked')?.value),
                    cordao: Boolean(document.querySelector('input[name="cordao"]:checked')?.value),
                    vaga_exclusiva: Boolean(document.querySelector('input[name="vaga-exclusiva"]:checked')?.value),
                },
                interesses: document.getElementById("interesses").value ?? [],
                hiperfoco: document.getElementById("hiperfoco").value ?? [],
                atividades_nao_gosta: document.getElementById("naogosta").value ?? [],
                restricoes_alimentares: document.getElementById("restricoes").value ?? [],
                terapias: {
                    faz: document.getElementById("terapia-faz").value ?? [],
                    precisa: document.getElementById("terapia-precisa").value ?? [],
                },
                como_acalma: document.getElementById("comoacalma").value,
                comida_favorita: document.getElementById("comida-fav").value,
                convenio: document.getElementById("convenio").value,
                observacoes: document.getElementById("observacoes").value,
                endereco: document.getElementById("endereco").value,
                escola: frequentaEscola ? {
                    nome: document.getElementById("escola").value || null,
                    tem_suporte: document.querySelector('input[name="escola-suporte"]:checked')?.value === "true"
                } : null,
                responsaveis: responsaveisArr.map(r => ({
                    nome: r.nome,
                    relacao: r.relacao,
                    contato: r.contato
                })),
                residentes: residentesArr.map(r => ({
                    nome: r.nome,
                    tipo: r.perfil
                })),
            };
            

            const fd = new FormData();

            fd.append("nome", dados.nome);
            fd.append("data_nascimento", dados.data_nascimento.toISOString());
            fd.append("nivel_suporte", dados.nivel_suporte);
            fd.append("identificacoes", JSON.stringify(dados.identificacoes));
            fd.append("como_acalma", dados.como_acalma);
            fd.append("comida_favorita", dados.comida_favorita);
            fd.append("convenio", dados.convenio);
            fd.append("observacoes", dados.observacoes);
            fd.append("endereco", dados.endereco);
            fd.append("escola", JSON.stringify(dados.escola));
            fd.append("responsaveis", JSON.stringify(dados.responsaveis));
            fd.append("residentes", JSON.stringify(dados.residentes));
            fd.append("interesses", JSON.stringify(dados.interesses));
            fd.append("hiperfoco", JSON.stringify(dados.hiperfoco));
            fd.append("atividades_nao_gosta", JSON.stringify(dados.atividades_nao_gosta));
            fd.append("restricoes_alimentares", JSON.stringify(dados.restricoes_alimentares));
            fd.append("terapias", JSON.stringify(dados.terapias));
            if (id_parente) fd.append("id_parente", id_parente || "");

            const fotoInput = document.getElementById("foto");

            if (fotoInput.files.length > 0) {
                fd.append("blob", fotoInput.files[0]);
            }

            fetch("/api/acolhidos", {
                method: "POST",
                body: fd
            }).then(resp => resp.json()).then(json => {
                if (json.status === "error") {
                    Swal.fire({
                        icon: "error",
                        title: "Houve um erro...",
                        text: json.message
                    });
                } else {
                    if (window.SOLICITACAO) {
                        fetch(`/api/solicitacoes/acolhidos/${window.SOLICITACAO.id}`, {
                            method: "DELETE",
                            headers: {
                                ["x-response-email"]: "accepted",
                            }
                        })
                    }
                    Swal.fire({
                        icon: "success",
                        title: "Acolhido cadastrado!",
                        text: "Volte ao gerenciamento para consultar."
                    }).then(() => {
                        window.location.href = "/gerenciamento";
                    });
                }
            })
        });
    </script>
    <script type="module">
        import ListInput from "/js/list_input.js";
        
        if (window.SOLICITACAO) {
            const fields = window.SOLICITACAO.fields;

            new ListInput(document.getElementById("terapia-faz"), ...(fields.terapias?.faz ?? []));
            new ListInput(document.getElementById("terapia-precisa"), ...(fields.terapias?.precisa ?? []));
            new ListInput(document.getElementById("interesses"), ...(fields.interesses ?? []));
            new ListInput(document.getElementById("hiperfoco"), ...(fields.hiperfoco ?? []));
            new ListInput(document.getElementById("naogosta"), ...(fields.atividades_nao_gosta ?? []));
            new ListInput(document.getElementById("restricoes"), ...(fields.restricoes_alimentares ?? []));
        } else {
            new ListInput(document.getElementById("terapia-faz"));
            new ListInput(document.getElementById("terapia-precisa"));
            new ListInput(document.getElementById("interesses"));
            new ListInput(document.getElementById("hiperfoco"));
            new ListInput(document.getElementById("naogosta"));
            new ListInput(document.getElementById("restricoes"));
        }
    </script>
</body>

</html>