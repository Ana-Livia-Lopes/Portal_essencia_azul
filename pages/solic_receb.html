<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solicitações recebidas</title>
    <link rel="stylesheet" href="/css/solic_receb.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
    <style>
        input {
            pointer-events: none;
        }

        body {
            min-height: 100vh;
        }
    </style>
    <component-acessibilidade />
    <component-json-solicitacoes_preload />

    <div class="voltar-div">
        <h3><a class="voltar" href="/gerenciamento"><i class="fa-solid fa-arrow-left" style="color: '#002293;'"></i>
                Voltar</a></h3>
    </div>


    <main>
        <div id="container-acolhidos">
            <section class="formulario-solicitacao-section-expansiva">
                <!-- <div class="form-wrapper">
                    <div class="titulo-filtro">
                        <span>Solicitação de <strong>cadastro</strong> feita por Joana</span>
                        
                        <i class="chevron fa fa-solid fa-chevron-down"></i>
                    </div>
    
                    <div class="conteudo">
                        <form>
                            <div class="form-grid">
                                <div class="campo">
                                    <label>Nome do autista</label>
                                    <input type="text" value="Lucas Silva" readonly>
                                </div>
                                <div class="campo">
                                    <label>Atividades que NÃO gosta</label>
                                    <input type="text" value="Barulho alto e multidões" readonly>
                                </div>
                                <div class="campo">
                                    <label class="conteudo-site" for="data-nascimento">Data de nascimento:</label>
                            <input class="conteudo-site" type="date" id="data-nascimento" />
                                </div>
                                <div class="label-input conteudo-site">
                                    <label class="conteudo-site" for="referencia-familia">Referência da família (uso
                                        interno):</label>
                                        <input class="conteudo-site" type="text" id="referencia-familia" />
                                    </div>
                                    <div class="campo">
                                        <label>Restrições alimentares</label>
                                        <input type="text" value="Sem glúten e lactose" readonly>
                                    </div>
                                <div class="campo">
                                    <label>Nível de suporte</label>
                                    <input type="text" value="Nível 2" readonly>
                                </div>
                                <div class="campo">
                                    <label>Comida favorita</label>
                                    <input type="text" value="Arroz, frango e batata" readonly>
                                </div>
                                <div class="campo">
                                    <label>Escola onde estuda ou não estuda</label>
                                    <input type="text" value="Escola Municipal Alegria" readonly>
                                </div>
                                <div class="campo">
                                    <label>Convênio ou SUS</label>
                                    <input type="text" value="SUS" readonly>
                                </div>
                                <div class="campo">
                                    <label>Carteirinha de identificação do autismo</label>
                                    <input type="text" value="Sim" readonly>
                                </div>
                                <div class="campo">
                                    <label>Usa cordão de girassol ou quebra-cabeça</label>
                                    <input type="text" value="Sim" readonly>
                                </div>
                                <div class="campo">
                                    <label>Cartão para vaga de estacionamento</label>
                                    <input type="text" value="Não" readonly>
                                </div>
                                <div class="campo">
                                    <label>Tem suporte na escola</label>
                                    <input type="text" value="Sim" readonly>
                                </div>
                                <div class="campo">
                                    <label>Áreas de interesse</label>
                                    <input type="text" value="Desenhos animados e dinossauros" readonly>
                                </div>
                                <div class="campo">
                                    <label>Hiperfoco</label>
                                    <input type="text" value="Construções com blocos" readonly>
                                </div>
                                <div class="campo">
                                    <label>Como se acalma</label>
                                    <input type="text" value="Ouvindo músicas calmas" readonly>
                                </div>
                                <div class="campo">
                                    <label>Quais terapias está fazendo</label>
                                    <input type="text" value="Fonoaudiologia e Terapia Ocupacional" readonly>
                                </div>
                                <div class="campo">
                                    <label>Terapias que precisa e NÃO faz</label>
                                    <input type="text" value="Fisioterapia" readonly>
                                </div>
                                <div class="campo full">
                                    <label>Observações</label>
                                    <textarea
                                    readonly>Lucas tem evoluído bem com a rotina de terapias e se comunica melhor com figuras visuais.</textarea>
                                </div>
    
                                <div class="campo">
                                    <label>Nome dos pais/responsáveis</label>
                                    <input type="text" value="Joana e Marcos Silva" readonly>
                                </div>
                                <div class="campo">
                                    <label>E-mail ou telefone de contato</label>
                                    <input type="text" value="joana.silva@email.com" readonly>
                                </div>
                                <div class="campo">
                                    <label>Relação com o acolhido</label>
                                    <input type="text" value="" readonly placeholder="Ex: Pai, tia, avó">
                                </div>
                                <div class="campo">
                                    <label>Endereço</label>
                                    <input type="text" value="Rua das Acácias, 123, São Paulo - SP" readonly>
                                </div>
                                <div class="campo">
                                    <label>Quantas pessoas moram na residência</label>
                                    <input type="text" value="4" readonly>
                                </div>
                            </div>
    
                            <div class="botoes">
                                <button type="button" class="aceitar">Confirmar</button>
                                <button type="button" class="recusar">Recusar</button>
                            </div>
                        </form>
                    </div>
                </div> -->
            </section>
        </div>

        <div id="container-voluntarios">

        </div>
    </main>
    <script>
        const containerAcolhidos = document.getElementById("container-acolhidos");
        const containerVoluntarios = document.getElementById("container-voluntarios");

        function acolhidoTextField() { }
        function acolhidoListField() { }
        function acolhidoRadioField() { }
        function acolhidoTextArea() { }

        function criarSolicitacaoAcolhido(acolhido) {
            const formContainer = document.createElement("section");
            formContainer.className = "formulario-solicitacao-acolhido";

            const formWrapper = document.createElement("div");
            formWrapper.className = "form-wrapper";

            const tituloFiltro = document.createElement("div");
            tituloFiltro.className = "titulo-filtro";
            console.log(acolhido)
            console.log("data_solicitacao:", acolhido.fields.data_solicitacao);
      
            let dataFormat = "Data não informada";
            if (acolhido.fields.data_solicitacao) {
                const data = new Date(acolhido.fields.data_solicitacao);
                if (!isNaN(data.getTime())) {
                    dataFormat = data.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' }) +
                    " às " + data.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                }
            }


            tituloFiltro.innerHTML = `
            <span>Solicitação de <strong>acolhido</strong> para ${acolhido.fields.nome}</span>
            <p>${dataFormat}</p>
            <i class="chevron fa fa-solid fa-chevron-down"></i>
`;

            const conteudo = document.createElement("div");
            conteudo.className = "conteudo";
            conteudo.style.display = "none";

            const botoesDiv = document.createElement("div");
            botoesDiv.className = "botoes";

            const aceitarButton = document.createElement("button");
            aceitarButton.type = "button";
            aceitarButton.className = "aceitar";
            aceitarButton.textContent = "Confirmar";
            aceitarButton.addEventListener("click", () => {
                window.location.href = `/gerenciamento/cadastrar_acolhido?id=${acolhido.id}`;
            });

            const recusarButton = document.createElement("button");
            recusarButton.type = "button";
            recusarButton.className = "recusar";
            recusarButton.textContent = "Recusar";
            recusarButton.addEventListener("click", () => {
                Swal.fire({
                    icon: "warning",
                    title: "Tem certeza que deseja recusar?",
                    text: "Esta ação é permanente",
                    showCancelButton: true,
                    confirmButtonText: "Sim, recusar",
                    confirmButtonColor: "#1535B5",
                    cancelButtonText: "Cancelar",
                }).then(result => {
                    if (result.isConfirmed) {
                        fetch(`/api/solicitacoes/acolhidos/${acolhido.id}`, {
                            method: "DELETE",
                            headers: {
                                ["x-response-email"]: "refused",
                            }
                        }).then(resp => resp.json()).then(json => {
                            Swal.fire({
                                icon: "success",
                                title: "Solicitação recusada com sucesso!",
                                confirmButtonColor: "#1535B5"
                            }).then(() => {
                                formContainer.remove();
                            });
                        });
                    }
                });
            });

            botoesDiv.appendChild(aceitarButton);
            botoesDiv.appendChild(recusarButton);
            conteudo.appendChild(botoesDiv);

            setTimeout(() => {
                const chevron = tituloFiltro.querySelector(".chevron");
                chevron.addEventListener("click", () => {
                    if (conteudo.style.display === "block") {
                        conteudo.style.display = "none";
                        chevron.classList.add("rotacionado");
                    } else {
                        conteudo.style.display = "block";
                        chevron.classList.remove("rotacionado");
                    }
                });
            }, 0);

            formWrapper.appendChild(tituloFiltro);
            formWrapper.appendChild(conteudo);
            formContainer.appendChild(formWrapper);
            containerAcolhidos.appendChild(formContainer);
        }


        function voluntarioTextField(label, text) {
            const campoDiv = document.createElement("div");
            campoDiv.className = "campo";
            const labelElement = document.createElement("label");
            labelElement.textContent = label;
            const inputElement = document.createElement("input");
            inputElement.type = "text";
            inputElement.value = text;
            inputElement.readOnly = true;
            campoDiv.appendChild(labelElement);
            campoDiv.appendChild(inputElement);
            return campoDiv;
        }
        function voluntarioFullWidthTextField(label, text) {
            const campoDiv = voluntarioTextField(label, text);
            campoDiv.style.gridColumn = "1 / span 2";
            return campoDiv;
        }
        function voluntarioTextArea(label, text) {
            const campoDiv = document.createElement("div");
            campoDiv.className = "campo full";
            const labelElement = document.createElement("label");
            labelElement.textContent = label;
            const textareaElement = document.createElement("textarea");
            textareaElement.value = text;
            textareaElement.readOnly = true;
            campoDiv.appendChild(labelElement);
            campoDiv.appendChild(textareaElement);
            return campoDiv;
        }

        function criarSolicitacaoVoluntario(voluntario) {
            const formContainer = document.createElement("section");
            formContainer.className = "formulario-solicitacao-voluntario";
            const formWrapper = document.createElement("div");
            formWrapper.className = "form-wrapper";
            const tituloFiltro = document.createElement("div");
            tituloFiltro.className = "titulo-filtro";

            const data = new Date(voluntario.fields.data_solicitacao);
            const dataFormat = data.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' }) +
                " às " + data.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

            tituloFiltro.innerHTML = `<span>Solicitação de <strong>voluntário</strong> de ${voluntario.fields.nome}</span>
                                      <p>${dataFormat}</p>
                                      <i class="chevron fa fa-solid fa-chevron-down"></i>`;
            const conteudo = document.createElement("div");
            conteudo.className = "conteudo";
            const form = document.createElement("form");
            const formGrid = document.createElement("div");
            formGrid.className = "form-grid";
            formGrid.appendChild(voluntarioTextField("Nome completo", voluntario.fields.nome));
            formGrid.appendChild(voluntarioTextField("CPF", voluntario.fields.cpf));
            formGrid.appendChild(voluntarioTextField("Email", voluntario.fields.email));
            formGrid.appendChild(voluntarioTextField("Telefone", voluntario.fields.telefone));
            formGrid.appendChild(voluntarioFullWidthTextField("Como quer ajudar?", voluntario.fields.como_ajudar));
            formGrid.appendChild(voluntarioTextArea("Por que quer ser voluntário?", voluntario.fields.por_que_ser_voluntario));
            form.appendChild(formGrid);
            formWrapper.appendChild(tituloFiltro);
            formWrapper.appendChild(conteudo);
            conteudo.appendChild(form);
            const botoesDiv = document.createElement("div");
            botoesDiv.className = "botoes";
            const aceitarButton = document.createElement("button");
            aceitarButton.type = "button";
            aceitarButton.className = "aceitar";
            aceitarButton.textContent = "Aceitar";
            aceitarButton.addEventListener("click", () => {
                Swal.fire({
                    title: "Confirmar aceitação",
                    text: "Tem certeza que deseja aceitar este voluntário?",
                    icon: "question",
                    showCancelButton: true,
                    confirmButtonText: "Sim, aceitar",
                    confirmButtonColor: "#1535B5",
                    cancelButtonText: "Cancelar",
                }).then(result => {
                    if (result.isConfirmed) {
                        const fd = new FormData();
                        fd.append("nome", voluntario.fields.nome);
                        fd.append("cpf", voluntario.fields.cpf);
                        fd.append("email", voluntario.fields.email);
                        fd.append("telefone", voluntario.fields.telefone);
                        fd.append("como_ajudar", voluntario.fields.como_ajudar);
                        fd.append("por_que_ser_voluntario", voluntario.fields.por_que_ser_voluntario);

                        fetch("/api/voluntarios", {
                            method: "POST",
                            body: fd
                        }).then(resp => resp.json()).then(json => {
                            if (json.status === "error") {
                                Swal.fire({
                                    icon: "error",
                                    title: "Erro ao aceitar voluntário",
                                    text: json.message,
                                    confirmButtonColor: "#1535B5"
                                });
                            } else {
                                fetch(`/api/solicitacoes/voluntarios/${voluntario.id}`, {
                                    method: "DELETE",
                                    headers: {
                                        ["x-response-email"]: "accepted",
                                    }
                                }).then(resp => resp.json()).then(json => {
                                    if (json.status === "error") {
                                        Swal.fire({
                                            icon: "error",
                                            title: "Erro ao remover solicitação antiga, porém foi aceita com sucesso",
                                            text: json.message,
                                            confirmButtonColor: "#1535B5"
                                        });
                                    } else {
                                        Swal.fire({
                                            icon: "success",
                                            title: "Voluntário aceito com sucesso!",
                                            text: "O voluntário foi adicionado ao sistema.",
                                            confirmButtonColor: "#1535B5"
                                        }).then(() => {
                                            formContainer.remove();
                                        });
                                    }
                                })
                            }
                        })
                    }
                })
            });
            const recusarButton = document.createElement("button");
            recusarButton.type = "button";
            recusarButton.className = "recusar";
            recusarButton.textContent = "Recusar";
            recusarButton.addEventListener("click", () => {
                Swal.fire({
                    icon: "warning",
                    title: "Tem certeza que deseja recusar?",
                    text: "Esta ação é permanente",
                    showCancelButton: true,
                    confirmButtonText: "Sim, recusar",
                    confirmButtonColor: "#1535B5",
                    cancelButtonText: "Cancelar",
                }).then(result => {
                    if (result.isConfirmed) {
                        fetch(`/api/solicitacoes/voluntarios/${voluntario.id}`, {
                            method: "DELETE",
                            headers: {
                                ["x-response-email"]: "refused",
                            }
                        }).then(resp => resp.json()).then(json => {
                            if (json.status === "error") {
                                Swal.fire({
                                    icon: "error",
                                    title: "Erro ao recusar voluntário",
                                    text: json.message,
                                    confirmButtonColor: "#1535B5"
                                });
                            } else {
                                Swal.fire({
                                    icon: "success",
                                    title: "Voluntário recusado com sucesso!",
                                    text: "A solicitação foi removida.",
                                    confirmButtonColor: "#1535B5"
                                }).then(() => {
                                    formContainer.remove();
                                });
                            }
                        })
                    }
                })
            })
            botoesDiv.appendChild(aceitarButton);
            botoesDiv.appendChild(recusarButton);
            form.appendChild(botoesDiv);
            formContainer.appendChild(formWrapper);
            containerVoluntarios.appendChild(formContainer);
        }

        for (const voluntario of window.SOLICITACOES_VOLUNTARIOS) {
            criarSolicitacaoVoluntario(voluntario);
        }
        for (const acolhido of window.SOLICITACOES_ACOLHIDOS || []) {
            criarSolicitacaoAcolhido(acolhido);
        }
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const chevrons = document.querySelectorAll(".chevron");

            chevrons.forEach(chevron => {
                chevron.addEventListener("click", () => {
                    const wrapper = chevron.closest(".form-wrapper");
                    const conteudo = wrapper.querySelector(".conteudo");

                    conteudo.classList.toggle("expandido");
                    chevron.classList.toggle("rotacionado");
                });
            });
        });
    </script>

</body>

</html>